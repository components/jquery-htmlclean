/*
HTML Clean for jQuery
Anthony Johnston
http://www.antix.co.uk

version 1.3.0

$Revision: 67 $

requires jQuery http://jquery.com

Use and distibution http://www.opensource.org/licenses/bsd-license.php

2010-04-02 allowedTags/removeTags added (white/black list) thanks to David Wartian (Dwartian)
2010-06-30 replaceStyles added for replacement of bold, italic, super and sub styles on a tag
2012-04-30 allowedAttributes added, an array of attributed allowed on the elements
*/(function(e){function t(e,t,n,r){if(!e.tag.isInline&&n.length>0){n.push("\n");for(i=0;i<r;i++)n.push("	")}}function n(r,i){var s=[],o=r.attributes.length==0,u,h=this.name.concat(r.tag.rawAttributes==undefined?"":r.tag.rawAttributes),d=!0;if(i.allowedTags.length===0||e.inArray(r.tag.name,i.allowedTags)<0)d=!1;i.removeTags.length!==0&&e.inArray(r.tag.name,i.removeTags)>-1&&(d=!1),!r.isRoot&&d&&(s.push("<"),s.push(r.tag.name),e.each(r.attributes,function(){if(e.inArray(this.name,i.removeAttrs)==-1){var t=RegExp(/^(['"]?)(.*?)['"]?$/).exec(this.value),n=t[2],o=t[1]||"'";this.name=="class"&&(n=e.grep(n.split(" "),function(t){return e.grep(i.allowedClasses,function(n){return n[0]==t&&(n.length==1||e.inArray(r.tag.name,n[1])>-1)}).length>0}).join(" "),o="'"),n!=null&&(n.length>0||e.inArray(this.name,r.tag.requiredAttributes)>-1)&&(s.push(" "),s.push(this.name),s.push("="),s.push(o),s.push(n),s.push(o))}}));if(r.tag.isSelfClosing)d&&s.push(" />"),o=!1;else if(r.tag.isNonClosing)o=!1;else{!r.isRoot&&d&&s.push(">");var u=i.formatIndent++;if(r.tag.toProtect){var v=e.htmlClean.trim(r.children.join("")).replace(/<br>/ig,"\n");s.push(v),o=v.length==0}else{var v=[];for(var m=0;m<r.children.length;m++){var g=r.children[m],y=e.htmlClean.trim(p(l(g)?g:g.childrenToString()));c(g)&&m>0&&y.length>0&&(a(g)||f(r.children[m-1]))&&v.push(" ");if(l(g))y.length>0&&v.push(y);else if(m!=r.children.length-1||g.tag.name!="br")i.format&&t(g,i,v,u),v=v.concat(n(g,i))}i.formatIndent--,v.length>0&&(i.format&&v[0]!="\n"&&t(r,i,s,u),s=s.concat(v),o=!1)}!r.isRoot&&d&&(i.format&&t(r,i,s,u-1),s.push("</"),s.push(r.tag.name),s.push(">"))}return!r.tag.allowEmpty&&o?[]:s}function r(t,n,i){return i=i||1,e.inArray(t[t.length-i].tag.name,n)>-1?!0:t.length-(i+1)>0&&r(t,n,i+1)?(t.pop(),!0):!1}function s(e){return e?(this.tag=e,this.isRoot=!1):(this.tag=new u("root"),this.isRoot=!0),this.attributes=[],this.children=[],this.hasAttribute=function(e){for(var t=0;t<this.attributes.length;t++)if(this.attributes[t].name==e)return!0;return!1},this.childrenToString=function(){return this.children.join("")},this}function o(e,t){return this.name=e,this.value=t,this}function u(t,n,r,i){this.name=t.toLowerCase(),this.isSelfClosing=e.inArray(this.name,b)>-1,this.isNonClosing=e.inArray(this.name,w)>-1,this.isClosing=n!=undefined&&n.length>0,this.isInline=e.inArray(this.name,d)>-1,this.disallowNest=e.inArray(this.name,v)>-1,this.requiredParent=g[e.inArray(this.name,g)+1],this.allowEmpty=e.inArray(this.name,m)>-1,this.toProtect=e.inArray(this.name,y)>-1,this.rawAttributes=r,this.requiredAttributes=S[e.inArray(this.name,S)+1];if(i){i.tagAttributesCache||(i.tagAttributesCache=[]);if(e.inArray(this.name,i.tagAttributesCache)==-1){var s=E[e.inArray(this.name,E)+1].slice(0);for(var o=0;o<i.allowedAttributes.length;o++){var u=i.allowedAttributes[o][0];(i.allowedAttributes[o].length==1||e.inArray(this.name,i.allowedAttributes[o][1])>-1)&&e.inArray(u,s)==-1&&s.push(u)}i.tagAttributesCache.push(this.name),i.tagAttributesCache.push(s)}this.allowedAttributes=i.tagAttributesCache[e.inArray(this.name,i.tagAttributesCache)+1]}return this.render=!0,this}function a(t){while(h(t)&&t.children.length>0)t=t.children[0];return l(t)&&t.length>0&&e.htmlClean.isWhitespace(t.charAt(0))}function f(t){while(h(t)&&t.children.length>0)t=t.children[t.children.length-1];return l(t)&&t.length>0&&e.htmlClean.isWhitespace(t.charAt(t.length-1))}function l(e){return e.constructor==String}function c(e){return l(e)||e.tag.isInline}function h(e){return e.constructor==s}function p(e){return e.replace(/&nbsp;|\n/g," ").replace(/\s\s+/g," ")}e.fn.htmlClean=function(t){return this.each(function(){var n=e(this);this.value?this.value=e.htmlClean(this.value,t):this.innerHTML=e.htmlClean(this.innerHTML,t)})},e.htmlClean=function(t,i){i=e.extend({},e.htmlClean.defaults,i);var a=/<(\/)?(\w+:)?([\w]+)([^>]*)>/gi,f=/(\w+)=(".*?"|'.*?'|[^\s>]*)/gi,c,h=new s,p=[h],d=h,v=!1;i.bodyOnly&&(c=/<body[^>]*>((\n|.)*)<\/body>/i.exec(t))&&(t=c[1]),t=t.concat("<xxx>");var m;while(c=a.exec(t)){var g=new u(c[3],c[1],c[4],i),y=t.substring(m,c.index);if(y.length>0){var b=d.children[d.children.length-1];d.children.length>0&&l(b=d.children[d.children.length-1])?d.children[d.children.length-1]=b.concat(y):d.children.push(y)}m=a.lastIndex;if(g.isClosing)r(p,[g.name])&&(p.pop(),d=p[p.length-1]);else{var w=new s(g),E;while(E=f.exec(g.rawAttributes)){if(E[1].toLowerCase()=="style"&&i.replaceStyles){var S=!g.isInline;for(var x=0;x<i.replaceStyles.length;x++)i.replaceStyles[x][0].test(E[2])&&(S||(g.render=!1,S=!0),d.children.push(w),p.push(w),d=w,g=new u(i.replaceStyles[x][1],"","",i),w=new s(g))}g.allowedAttributes!=null&&(g.allowedAttributes.length==0||e.inArray(E[1],g.allowedAttributes)>-1)&&w.attributes.push(new o(E[1],E[2]))}e.each(g.requiredAttributes,function(){var e=this.toString();w.hasAttribute(e)||w.attributes.push(new o(e,""))});for(var T=0;T<i.replace.length;T++)for(var N=0;N<i.replace[T][0].length;N++){var C=typeof i.replace[T][0][N]=="string";if(C&&i.replace[T][0][N]==g.name||!C&&i.replace[T][0][N].test(c)){g.render=!1,d.children.push(w),p.push(w),d=w,g=new u(i.replace[T][1],c[1],c[4],i),w=new s(g),w.attributes=d.attributes,T=i.replace.length;break}}var k=!0;d.isRoot||(d.tag.isInline&&!g.isInline?k=!1:d.tag.disallowNest&&g.disallowNest&&!g.requiredParent?k=!1:g.requiredParent&&(k=r(p,g.requiredParent))&&(d=p[p.length-1]));if(k){d.children.push(w);if(g.toProtect)while(tagMatch2=a.exec(t)){var L=new u(tagMatch2[3],tagMatch2[1],tagMatch2[4],i);if(L.isClosing&&L.name==g.name){w.children.push(RegExp.leftContext.substring(m)),m=a.lastIndex;break}}else!g.isSelfClosing&&!g.isNonClosing&&(p.push(w),d=w)}}}return e.htmlClean.trim(n(h,i).join(""))},e.htmlClean.defaults={bodyOnly:!0,allowedTags:[],removeTags:["basefont","center","dir","font","frame","frameset","iframe","isindex","menu","noframes","s","strike","u"],allowedAttributes:[],removeAttrs:[],allowedClasses:[],format:!1,formatIndent:0,replace:[[["b","big"],"strong"],[["i"],"em"]],replaceStyles:[[/font-weight:\s*bold/i,"strong"],[/font-style:\s*italic/i,"em"],[/vertical-align:\s*super/i,"sup"],[/vertical-align:\s*sub/i,"sub"]]},e.htmlClean.trim=function(t){return e.htmlClean.trimStart(e.htmlClean.trimEnd(t))},e.htmlClean.trimStart=function(t){return t.substring(e.htmlClean.trimStartIndex(t))},e.htmlClean.trimStartIndex=function(t){for(var n=0;n<t.length-1&&e.htmlClean.isWhitespace(t.charAt(n));n++);return n},e.htmlClean.trimEnd=function(t){return t.substring(0,e.htmlClean.trimEndIndex(t))},e.htmlClean.trimEndIndex=function(t){for(var n=t.length-1;n>=0&&e.htmlClean.isWhitespace(t.charAt(n));n--);return n+1},e.htmlClean.isWhitespace=function(t){return e.inArray(t,x)!=-1};var d=["a","abbr","acronym","address","b","big","br","button","caption","cite","code","del","em","font","hr","i","input","img","ins","label","legend","map","q","s","samp","select","small","span","strike","strong","sub","sup","tt","u","var"],v=["h1","h2","h3","h4","h5","h6","p","th","td"],m=["th","td"],g=[null,"li",["ul","ol"],"dt",["dl"],"dd",["dl"],"td",["tr"],"th",["tr"],"tr",["table","thead","tbody","tfoot"],"thead",["table"],"tbody",["table"],"tfoot",["table"]],y=["script","style","pre","code"],b=["br","hr","img","link","meta"],w=["!doctype","?xml"],E=[["class"],"?xml",[],"!doctype",[],"a",["accesskey","class","href","name","title","rel","rev","type","tabindex"],"abbr",["class","title"],"acronym",["class","title"],"blockquote",["cite","class"],"button",["class","disabled","name","type","value"],"del",["cite","class","datetime"],"form",["accept","action","class","enctype","method","name"],"input",["accept","accesskey","alt","checked","class","disabled","ismap","maxlength","name","size","readonly","src","tabindex","type","usemap","value"],"img",["alt","class","height","src","width"],"ins",["cite","class","datetime"],"label",["accesskey","class","for"],"legend",["accesskey","class"],"link",["href","rel","type"],"meta",["content","http-equiv","name","scheme","charset"],"map",["name"],"optgroup",["class","disabled","label"],"option",["class","disabled","label","selected","value"],"q",["class","cite"],"script",["src","type"],"select",["class","disabled","multiple","name","size","tabindex"],"style",["type"],"table",["class","summary"],"th",["class","colspan","rowspan"],"td",["class","colspan","rowspan"],"textarea",["accesskey","class","cols","disabled","name","readonly","rows","tabindex"]],S=[[],"img",["alt"]],x=["Â "," ","	","\n","\r","\f"]})(jQuery);